@model ManagePrescriptionViewModel

@{
    ViewData["Title"] = "Manage Prescription";
    Layout = "~/Views/Shared/_PharmacistLayout.cshtml";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<div class="container mt-5 mb-5">
    <div class="card shadow-sm rounded-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Manage Prescription</h4>
        </div>

        <div class="card-body">
            <!-- Prescription Details -->
            <section class="mb-4">
                <h5 class="mb-3 text-primary"><i class="bi bi-file-earmark-text me-1"></i>Prescription Details</h5>
                <dl class="row">
                    <dt class="col-sm-3">Prescription ID</dt>
                    <dd class="col-sm-9">@Model.PrescriptionId</dd>

                    <dt class="col-sm-3">Patient Name</dt>
                    <dd class="col-sm-9">@Model.PatientName</dd>

                    <dt class="col-sm-3">Date Added</dt>
                    <dd class="col-sm-9">@Model.DateAdded.ToString("yyyy-MM-dd")</dd>

                    <dt class="col-sm-3">Status</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-secondary">@Model.Status</span>
                    </dd>

                    <dt class="col-sm-3">Is Agent</dt>
                    <dd class="col-sm-9">
                        <span class="badge bg-@(Model.IsAgent ? "danger" : "info")">
                            @(Model.IsAgent ? "Urgent" : "Non-Urgent")
                        </span>
                    </dd>

                    <dt class="col-sm-3">Instruction</dt>
                    <dd class="col-sm-9">@Model.Instruction</dd>

                    <dt class="col-sm-3">Rejection Note</dt>
                    <dd class="col-sm-9">
                        @if (!string.IsNullOrEmpty(Model.RejectionNote))
                        {
                            <span class="text-danger">@Model.RejectionNote</span>
                        }
                        else
                        {
                            <span class="text-muted">None</span>
                        }
                    </dd>
                </dl>
            </section>

            <!-- Medications -->
            <section class="mb-4">
                <h5 class="mb-3 text-primary"><i class="bi bi-capsule-pill me-1"></i>Medications</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Medication Name</th>
                                <th>Quantity</th>
                                <th>Dosage Form</th>
                                <th>Instruction</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var medication in Model.Medications)
                            {
                                <tr>
                                    <td>@medication.MedicationName</td>
                                    <td>@medication.Quantity</td>
                                    <td>@medication.DosageForm</td>
                                    <td>@medication.Instruction</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Action Buttons -->
            <div class="d-flex gap-2">
                @if (Model.Status != "Dispensed")
                {
                    <form asp-action="DispenseMedication" asp-controller="Pharmacist" method="post">
                        <input type="hidden" name="prescriptionId" value="@Model.PrescriptionId" />
                        <input type="hidden" name="quantity" value="@Model.Medications.Sum(m => m.Quantity)" />
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i> Dispense Medication
                        </button>
                    </form>
                }

                @if (Model.Status != "Dispensed" && Model.Status != "Rejected")
                {
                    <a asp-action="RejectPrescription" asp-route-prescriptionId="@Model.PrescriptionId" class="btn btn-danger">
                        <i class="bi bi-x-circle me-1"></i> Reject
                    </a>
                }

                <a href="@Url.Action("PrescriptionList", "Surgeon")" class="btn btn-secondary ms-auto">
                    <i class="bi bi-arrow-left-circle me-1"></i> Back to Prescriptions
                </a>
            </div>
        </div>
    </div>
</div>
