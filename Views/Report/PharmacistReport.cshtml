@model E_PRESCRIBING_SYSTEM.Models.PharmacistReportViewModel

@{
    ViewData["Title"] = "Pharmacist Report";
    Layout = "~/Views/Shared/_PharmacistLayout.cshtml";
}

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/css/PharmacistReport.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 
   
</head>

<div class="form-card" id="card-content">
    <h2 class="text-center">PHARMACIST REPORT (Sorted by date)</h2>
    <h4>DISPENSARY REPORT</h4>
    <h5>Report Generated: @Model.ReportGeneratedDate.ToString("d MMMM yyyy")</h5>
    <p>Date Range: @Model.StartDate.ToString("d MMMM yyyy") – @Model.EndDate.ToString("d MMMM yyyy")</p>

    <div class="no-break">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>DATE</th>
                    <th>PATIENT</th>
                    <th>SCRIPT BY</th>
                    <th>MEDICATION(S)</th>
                    <th>QTY</th>
                    <th>STATUS</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var prescription in Model.Prescriptions)
                {
                    <tr>
                        <td>@prescription.DateAdded.ToString("d MMM yyyy")</td>
                        <td>@prescription.PatientProfile?.PatientName</td>
                        <td>@prescription.Username</td>
                        <td>
                            <ul>
                                @foreach (var med in prescription.PrescriptionMedications)
                                {
                                    <li>@med.PharmacyMedication?.Name</li>
                                }
                            </ul>
                        </td>
                        <td>
                            <ul>
                                @foreach (var med in prescription.PrescriptionMedications)
                                {
                                    <li>@med.Quantity</li>
                                }
                            </ul>
                        </td>
                        <td>@prescription.Status</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="row mb-4 no-break">
        <div class="col-md-6">
            <div class="alert alert-success">
                <strong>Total Scripts Dispensed:</strong> @Model.TotalScriptsDispensed
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-danger">
                <strong>Total Scripts Rejected:</strong> @Model.TotalScriptsRejected
            </div>
        </div>
    </div>

    <div class="no-break">
        <h4>SUMMARY PER MEDICINE:</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>MEDICINE</th>
                    <th>QTY DISPENSED</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.MedicationSummary)
                {
                    <tr>
                        <td>@item.Key</td>
                        <td>@item.Value</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="no-break">
        <h4>BAR CHART: Medication Dispensed</h4>
        <div style="width: 100%; height: 300px;">
            <canvas id="medicationBarChart"></canvas>
        </div>
    </div>
</div>

<div class="d-flex justify-content-end mt-2">
    <button type="button" onclick="downloadPDF()" class="btn btn-danger btn-sm btn-download">
        <i class="fas fa-download"></i> Download PDF
    </button>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        function downloadPDF() {
            const element = document.getElementById('card-content');
            html2pdf()
                .from(element)
                .set({
                    margin: 5,
                    filename: 'PharmacistReport.pdf',
                    html2canvas: { scale: 1 },
                    jsPDF: {
                        unit: 'mm',
                        format: [210, 600], // Custom A4-width, tall height
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all'] }
                })
                .save();
        }

        const ctx = document.getElementById('medicationBarChart').getContext('2d');
        const medicationNames = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.MedicationSummary.Keys));
        const medicationQuantities = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.MedicationSummary.Values));

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: medicationNames,
                datasets: [{
                    label: 'Quantity Dispensed',
                    data: medicationQuantities,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantity'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Medication'
                        }
                    }
                }
            }
        });
    </script>
}
